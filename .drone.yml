kind: pipeline
name: build monitoring

globals:
  - &tf_vars
    VERSION: 1.0.1
    
steps:
  - name: trivy image
    image: aquasec/trivy
    environment:
      <<: *tf_vars
    commands:
      - trivy image --exit-code 0 --severity LOW,MEDIUM,HIGH plugins/docker:19.03.8 
      - trivy image --exit-code 1 --severity CRITICAL plugins/docker:19.03.8 
      
  - name: dockle image
    image: goodwithtech/dockle
    environment:
      <<: *tf_vars
    commands:
      - dockle --ignore CIS-DI-0009 --exit-code 1 --exit-level fatal plugins/docker:19.03.8 
      
  - name: grype image
    image: ubuntu:20.04
    environment:
      <<: *tf_vars
    commands:
      - apt-get update
      - apt-get -y install curl
      - curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin
      - grype plugins/docker:19.03.8 --scope all-layers --fail-on critical
      
      
      
   
   
      
